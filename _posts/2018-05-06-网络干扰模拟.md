---
layout: post
title: 网络干扰模拟                                # Title of the page
hide_title: false                                  # Hide the title when displaying the post, but shown in lists of posts
bootstrap: true                                   # Add bootstrap to the page
tags: [clumsy, 网络, windows]
published: true
excerpt_separator: <!--more-->
---

<!--more-->
* TOC
{:toc}

# 1. 背景

有一次开发的Windows软件部署到草原，通过Wifi网络访问几公里之外的视频源，图像严重卡顿、引发崩溃，公司环境无法模拟，远程无法调试软件，导致项目迟迟无法交付。这也是许多ToB行业中常见现象，开发环境中的网络质量很好，实际生产环境却各有差异，由于难以模拟网络质量的变化，继而忽视，自然而然就有可靠性问题，同样由于没有模拟环境，遇到问题时又很难快速解决。

其实软件行业发展数十年，你遇到的大多数基础问题早就被解决过不止一次，Google一搜就找到[How can I simulate a bad internet connection for testing purposes?](https://gamedev.stackexchange.com/questions/61483/how-can-i-simulate-a-bad-internet-connection-for-testing-purposes)，通过[Clumsy](https://github.com/jagt/clumsy)，模拟出网络质量变化后每次都能复现崩溃，后面解决就是顺理成章了。

# 2. [Clumsy](https://github.com/jagt/clumsy)

1. [Clumsy下载](http://jagt.github.io/clumsy/download)
2. [Clumsy命令行参数](https://github.com/jagt/clumsy/wiki/Command-Line-Arguments)

## 2.1. 运行

既可以手动点击软件，再输入框中填写想要干扰的途径和参数，也可以通过命令行：

**命令行示例**

`clumsy.exe --filter "tcp and (tcp.SrcPort == 8555)" --lag on --lag-inbound on --lag-outbound on --lag-delay 90 --drop on --drop-inbound on --drop-outbound on --drop-chance 90.0  --throttle on --throttle-timeframe 30 --throttle-inbound on --throttle-outbound on --throttle-chance 90.0  --duplicate on --duplicate-count 2 --duplicate-inbound on --duplicate-outbound on --duplicate-chance 90.0 --ood on --ood-inbound on --ood-outbound on --ood-chance 90.0  --tamper on --tamper-inbound on --tamper-outbound on --tamper-chance 90.0`


要求对来自8555的TCP数据包，执行干扰，随后弹出软件窗口，点击**Stop**可以关闭干扰，再次点击即可开启。

![clumsy命令行示例截图](/assets/img/post/2018-05-06-clumsy/clumsy.png)

有了命令行支持，就可以轻松使用Python之类脚本制作定时、按需干扰，通过定义不同干扰参数的测试用例，完善网络质量变化的可靠性测试。

## 2.2. 过滤器

可以根据TCP/UDP、IP地址，以及端口号等多种过滤条件的组合，其语法依赖[WinDivert](https://github.com/basil00/Divert)。

## 2.3. 干扰途径

* lag
* drop
* throttle
* duplicate
* out of order
* tamper

# 3. Clumsy原理

实现依赖[WinDivert](https://github.com/basil00/Divert)，WinDivert通过一个内核态驱动Windivert.sys去HOOK数据包返给用户态WinDivert.dll，从而实现数据包的捕获、修改和丢弃。说到这，是不是想象空间很大！对比抓包神器Wireshark依赖的Winpcap，则不能修改数据包。

# 4. 参考

1. [packet-data-intercept-and-modification](https://stackoverflow.com/questions/10306386/packet-data-intercept-and-modification)
2. [how-can-i-simulate-a-bad-internet-connection-for-testing-purposes](https://gamedev.stackexchange.com/questions/61483/how-can-i-simulate-a-bad-internet-connection-for-testing-purposes)