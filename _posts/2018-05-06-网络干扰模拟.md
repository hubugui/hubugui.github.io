---
layout: post
title: 网络干扰模拟                                # Title of the page
hide_title: false                                  # Hide the title when displaying the post, but shown in lists of posts
bootstrap: true                                   # Add bootstrap to the page
tags: [clumsy, 网络, windows]
published: true
excerpt_separator: <!--more-->
---

<!--more-->
* TOC
{:toc}

# 1. 背景

有一回一个Windows软件部署到草原，通过WIFI网络访问几公里之外的视频源，图像严重卡顿、引发崩溃，公司环境无法模拟，远程又没法调试软件，导致项目迟迟无法交付。这也是许多**ToB行业常见现象，开发环境中的网络QoS很好，实际生产环境却各有差异，由于难以模拟网络QoS的变化，继而忽视此类测试，自然而然就留下了可靠性问题，同样由于没有模拟环境，遇到问题时也很难快速解决。**

其实软件行业发展数十年，你遇到的大多数基础问题早就被解决过不止一次，Google一搜就找到[How can I simulate a bad internet connection for testing purposes?](https://gamedev.stackexchange.com/questions/61483/how-can-i-simulate-a-bad-internet-connection-for-testing-purposes)，MAC/Linux/Windows主流操作系统已有解决方案，在Windows上通过[Clumsy](https://github.com/jagt/clumsy)轻松模拟出网络QoS变化后，每次都能复现崩溃，后面的解决顺理成章。

即便如此，**事后努力解决再多bug都是下策，因为时间和人力、人心消耗了太高成本，修修补补属于抬高下限，要突破上限天花板，节省成本把资源投入到追寻更高价值的活动上来，应在计划之初重视软件如何使用、依赖环境的定义，从软件六性出发来完善测试用例，哪怕在紧急情况下可以先跳过某些用例，而不是忽视，这样可以帮助从一开始各个角色就对软件产品和使用环境有一个框架性认知，开展具体工作时除了发布计划中的当下、还能看到未来，这是品质之道。**

下面简单说说Clumsy。

# 2. [Clumsy](https://github.com/jagt/clumsy)

* [Clumsy下载](http://jagt.github.io/clumsy/download)
* [Clumsy命令行参数](https://github.com/jagt/clumsy/wiki/Command-Line-Arguments)

## 2.1. 运行

既可以手动点击软件，在输入框中填写想要干扰的途径和参数，也可以通过命令行：

**命令行示例**

`clumsy.exe --filter "tcp and (tcp.SrcPort == 8555)" --lag on --lag-inbound on --lag-outbound on --lag-delay 90 --drop on --drop-inbound on --drop-outbound on --drop-chance 90.0  --throttle on --throttle-timeframe 30 --throttle-inbound on --throttle-outbound on --throttle-chance 90.0  --duplicate on --duplicate-count 2 --duplicate-inbound on --duplicate-outbound on --duplicate-chance 90.0 --ood on --ood-inbound on --ood-outbound on --ood-chance 90.0  --tamper on --tamper-inbound on --tamper-outbound on --tamper-chance 90.0`


要求对来自8555的TCP数据包执行干扰，随后弹出软件窗口，点击**Stop**按钮关闭干扰，再次点击即可开启。

![clumsy命令行示例截图](/assets/img/post/2018-05-06-clumsy/clumsy.png)

**有了命令行支持，就可以轻松使用Python之类脚本制作定时、按需干扰，通过定义不同干扰参数的测试用例，完善网络质量变化的可靠性测试。**

## 2.2. 过滤器

命令行中可以通过`--filter`指定网络参数来标识干扰什么样的网络包，比如指定源IP、TCP/UDP，以及端号等多种过滤条件的组合。点击GUI中**filtering**下方**Presets**下拉框选择某个常用选项后会自动产生过滤器显示到输入框，你可以继续手动编辑。
由于拦截数据包的核心功能依赖[WinDivert](https://github.com/basil00/Divert)，所以过滤器语法也依赖WinDivert。

## 2.3. 干扰途径

* lag，减慢数据包速度。
* drop，丢包。
* throttle，阻塞包再批量发送。
* duplicate，重复包。
* out of order，乱序包。
* tamper，篡改包。

下面截图是RTSP视频被丢包、乱序后花屏，过滤器是**开启Drop和Out of order，Chance填为50.0**。

![RTSP视频被丢包、乱序后花屏](/assets/img/post/2018-05-06-clumsy/video_mosaic.png)

# 3. Clumsy原理

[WinDivert](https://github.com/basil00/Divert)通过一个内核态驱动Windivert.sys去HOOK数据包返给用户态WinDivert.dll，从而实现数据包的捕获、修改和丢弃。说到这，是不是想象空间很大！抓包神器Wireshark依赖的Winpcap，则不能修改数据包。

# 4. 参考

1. [packet-data-intercept-and-modification](https://stackoverflow.com/questions/10306386/packet-data-intercept-and-modification)
2. [how-can-i-simulate-a-bad-internet-connection-for-testing-purposes](https://gamedev.stackexchange.com/questions/61483/how-can-i-simulate-a-bad-internet-connection-for-testing-purposes)